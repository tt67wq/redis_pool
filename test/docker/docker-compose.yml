version: "3.8"

services:
  # 单节点 Redis 6.2
  redis6:
    image: redis:6.2-alpine
    container_name: redis_pool_redis6
    ports:
      - "6379:6379"
    volumes:
      - redis6_data:/data
    command: redis-server --requirepass redis_password
    networks:
      - redis_net

  # 单节点 Redis 7.0
  redis7:
    image: redis:7.0-alpine
    container_name: redis_pool_redis7
    ports:
      - "6380:6379"
    volumes:
      - redis7_data:/data
    command: redis-server --requirepass redis_password
    networks:
      - redis_net

  # 模拟网络条件的 Redis 服务

  # 模拟网络延迟的 Redis
  redis-delayed:
    image: redis:6.2-alpine
    container_name: redis_pool_delayed
    ports:
      - "6384:6379"
    volumes:
      - redis_delayed_data:/data
    networks:
      - redis_net
    command: sh -c 'apk add --no-cache iproute2 && tc qdisc add dev eth0 root netem delay 100ms 20ms && redis-server --requirepass redis_password'

  # 模拟连接不稳定的 Redis
  redis-unstable:
    image: redis:6.2-alpine
    container_name: redis_pool_unstable
    ports:
      - "6385:6379"
    volumes:
      - redis_unstable_data:/data
    networks:
      - redis_net
    command: sh -c 'apk add --no-cache iproute2 && tc qdisc add dev eth0 root netem loss 10% 25% && redis-server --requirepass redis_password'

networks:
  redis_net:
    driver: bridge

volumes:
  redis6_data:
  redis7_data:

  redis_delayed_data:
  redis_unstable_data:
